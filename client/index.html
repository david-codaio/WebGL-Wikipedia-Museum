<!DOCTYPE html>
<html>
<head>
<title>Wikipedia Art Gallery</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="includes/wag.css" type="text/css" />

<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="includes/sylvester.js"></script>
<script type="text/javascript" src="includes/glUtils.js"></script>

<script type="text/javascript" src="includes/TeapotGenerator.js"></script>
<script type="text/javascript" src="includes/WorldGenerator.js"></script>
<script type="text/javascript" src="includes/Room.js"></script>
<script type="text/javascript" src="includes/Matrix.js"></script>
<script type="text/javascript" src="includes/Movement.js"></script>
<script type="text/javascript" src="includes/WAG.js"></script>
<script type="text/javascript" src="../shared/WAGConsts.js"></script>

<script type="text/javascript">
  var WAGinstance;
  var room;
  var gl;
  var currentProgram;

  function getShader(id, shader_type, cb) {
    var shaderScript = WAGinstance.programs[id];
    if (!shaderScript) {
      return null;
    }

    $.ajax({
      url: shaderScript[shader_type],
      dataType: "text",
      success: function(data) {
        var shader;
        if (shader_type == "fragment") {
          shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shader_type == "vertex") {
          shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
          cb(null);
        }

        gl.shaderSource(shader, data);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
          console.error("Error compiling shader: "+gl.getShaderInfoLog(shader));
          cb(null);
        }

        cb(shader);
      },
      error: function(xhr, textStatus, errorThrown) {
        console.error("Error: Unable to get shader "+id);
      }
    });
  }

  function createProgram(program_id, cb) {
    getShader(program_id, "fragment", function(fragmentShader) {
      getShader(program_id, "vertex", function(vertexShader) {
        var program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);

        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
          alert("Could not initialise shaders");
        }

        program.vertexPositionAttribute = gl.getAttribLocation(program, "aVertexPosition");
        gl.enableVertexAttribArray(program.vertexPositionAttribute);

        program.vertexNormalAttribute = gl.getAttribLocation(program, "aVertexNormal");
        gl.enableVertexAttribArray(program.vertexNormalAttribute);

        program.textureCoordAttribute = gl.getAttribLocation(program, "aTextureCoord");
        gl.enableVertexAttribArray(program.textureCoordAttribute);

        program.pMatrixUniform = gl.getUniformLocation(program, "uPMatrix");
        program.mvMatrixUniform = gl.getUniformLocation(program, "uMVMatrix");
        program.nMatrixUniform = gl.getUniformLocation(program, "uNMatrix");
        program.samplerUniform = gl.getUniformLocation(program, "uSampler");
        program.useTexturesUniform = gl.getUniformLocation(program, "uUseTextures");
        program.useLightingUniform = gl.getUniformLocation(program, "uUseLighting");
        program.ambientColorUniform = gl.getUniformLocation(program, "uAmbientColor");
        program.innerAngleUniform = gl.getUniformLocation(program, "uInnerAngle");
        program.outerAngleUniform = gl.getUniformLocation(program, "uOuterAngle");
        program.pointLightingLocation1Uniform = gl.getUniformLocation(program, "uPointLightingLocation1");
        program.pointLightingLocation2Uniform = gl.getUniformLocation(program, "uPointLightingLocation2");
        program.pointLightingLocation3Uniform = gl.getUniformLocation(program, "uPointLightingLocation3");
        program.pointLightingLocation4Uniform = gl.getUniformLocation(program, "uPointLightingLocation4");
        program.pointLightingColorUniform = gl.getUniformLocation(program, "uPointLightingColor");
        program.spotlightDirection1Uniform = gl.getUniformLocation(program, "uSpotlightDirection1");
        program.spotlightDirection2Uniform = gl.getUniformLocation(program, "uSpotlightDirection2");
        program.spotlightDirection3Uniform = gl.getUniformLocation(program, "uSpotlightDirection3");
        program.spotlightDirection4Uniform = gl.getUniformLocation(program, "uSpotlightDirection4");

        cb(program);
      });
    });
  }

  function setMatrixUniforms() {
    gl.uniformMatrix4fv(currentProgram.pMatrixUniform, false, new Float32Array(pMatrix.flatten()));
    gl.uniformMatrix4fv(currentProgram.mvMatrixUniform, false, new Float32Array(mvMatrix.flatten()));

    var normalMatrix = mvMatrix.inverse();
    normalMatrix = normalMatrix.transpose();
    gl.uniformMatrix4fv(currentProgram.nMatrixUniform, false, new Float32Array(normalMatrix.flatten()));
  }

  function drawScene() {
    gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    if (!room.hasCompletedLoading) {
      return;
    }

    perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0);

    if (document.getElementById("per-fragment-radio").checked) {
      currentProgram = WAGinstance.perFragmentProgram;
    } else if (document.getElementById("spotlight-radio").checked) {
      currentProgram = WAGinstance.spotlightProgram;
    }
    gl.useProgram(currentProgram);


    var lighting = document.getElementById("lighting").checked;
    gl.uniform1i(currentProgram.useLightingUniform, lighting);
    if (lighting) {
      gl.uniform3f(
        currentProgram.ambientColorUniform,
        parseFloat(document.getElementById("ambientR").value),
        parseFloat(document.getElementById("ambientG").value),
        parseFloat(document.getElementById("ambientB").value)
      );

      gl.uniform3f(
        currentProgram.pointLightingLocation1Uniform,
        parseFloat(document.getElementById("lightPositionX1").value),
        parseFloat(document.getElementById("lightPositionY1").value),
        parseFloat(document.getElementById("lightPositionZ1").value)
      );

      gl.uniform3f(
        currentProgram.pointLightingLocation2Uniform,
        parseFloat(document.getElementById("lightPositionX2").value),
        parseFloat(document.getElementById("lightPositionY2").value),
        parseFloat(document.getElementById("lightPositionZ2").value)
      );

      gl.uniform3f(
        currentProgram.pointLightingLocation3Uniform,
        parseFloat(document.getElementById("lightPositionX3").value),
        parseFloat(document.getElementById("lightPositionY3").value),
        parseFloat(document.getElementById("lightPositionZ3").value)
      );

      gl.uniform3f(
        currentProgram.pointLightingLocation4Uniform,
        parseFloat(document.getElementById("lightPositionX4").value),
        parseFloat(document.getElementById("lightPositionY4").value),
        parseFloat(document.getElementById("lightPositionZ4").value)
      );

      gl.uniform3f(
        currentProgram.pointLightingColorUniform,
        parseFloat(document.getElementById("pointR").value),
        parseFloat(document.getElementById("pointG").value),
        parseFloat(document.getElementById("pointB").value)
      );

      gl.uniform3f(
        currentProgram.spotlightDirection1Uniform,
        parseFloat(document.getElementById("directionX1").value),
        parseFloat(document.getElementById("directionY1").value),
        parseFloat(document.getElementById("directionZ1").value)
      );
      
      gl.uniform3f(
        currentProgram.spotlightDirection2Uniform,
        parseFloat(document.getElementById("directionX2").value),
        parseFloat(document.getElementById("directionY2").value),
        parseFloat(document.getElementById("directionZ2").value)
      );
      
      gl.uniform3f(
        currentProgram.spotlightDirection3Uniform,
        parseFloat(document.getElementById("directionX3").value),
        parseFloat(document.getElementById("directionY3").value),
        parseFloat(document.getElementById("directionZ3").value)
      );
      
      gl.uniform3f(
        currentProgram.spotlightDirection4Uniform,
        parseFloat(document.getElementById("directionX4").value),
        parseFloat(document.getElementById("directionY4").value),
        parseFloat(document.getElementById("directionZ4").value)
      );
      gl.uniform1f(
        currentProgram.innerAngleUniform,
        parseFloat(document.getElementById("inner_angle").value)
      );

      gl.uniform1f(
        currentProgram.outerAngleUniform,
        parseFloat(document.getElementById("outer_angle").value)
      );
    }

    var textures = document.getElementById("textures").checked;
    gl.uniform1i(currentProgram.useTexturesUniform, textures);

    loadIdentity();

    mvRotate(-pitch, [1, 0, 0]);
    mvRotate(-yaw, [0, 1, 0]);
    mvTranslate([-xPos, -yPos, -zPos]);

    room.renderComponents();
  }

  $(document).ready(function() {
    room = new Room(function() {
      $('#loadingtext').hide();
-      WAGinstance.startFetch();
    });

    WAGinstance = new WAG("wagCanvas");
    WAGinstance.initialize();
  });
</script>
</head>

<body>
  <canvas id="wagCanvas" style="border: none;" width="800" height="500"></canvas>
 
  <div id="loadingtext">Loading...</div>

  <br/>
Use the cursor keys or WASD to run around, and <code>Page Up</code>/<code>Page Down</code> (fn arrow keys on Mac) to
look up and down.
  <span id="advanced_visibility" onClick='$("#advanced").toggle();'>Advanced</span>
<div id="advanced" style="display:none;">
    <div id="debug"></div>
    <div id="debug2"></div>
      
    <label for="lighting"><input type="checkbox" id="lighting" checked="checked" /> Use lighting</label>
    <label for="textures"><input type="checkbox" id="textures" checked="checked" /> Use textures</label>
    <label for="per-fragment-radio"><input type="radio" name="shader" id="per-fragment-radio" value="per-fragment" checked="checked" /> Per-fragment</label>
    <label for="spotlight-radio"><input type="radio" name="shader" id="spotlight-radio" value="spotlight" /> Spotlight</label>
    <br/>
    
    <table id="parameterTable">
    <tr>
    <th>Position1:</th>
    <td>X: <input type="text" id="lightPositionX1" value="0" /></td>
    <td>Y: <input type="text" id="lightPositionY1" value="0.5" /></td>
    <td>Z: <input type="text" id="lightPositionZ1" value="0" /></td>
    <th>Position2:</th>
    <td>X: <input type="text" id="lightPositionX2" value="-1.5" /></td>
    <td>Y: <input type="text" id="lightPositionY2" value="0.5" /></td>
    <td>Z: <input type="text" id="lightPositionZ2" value="-1.5" /></td>
    <th>Position3:</th>
    <td>X: <input type="text" id="lightPositionX3" value="1.0" /></td>
    <td>Y: <input type="text" id="lightPositionY3" value="0.5" /></td>
    <td>Z: <input type="text" id="lightPositionZ3" value="-1.5" /></td>
    <th>Position4:</th>
    <td>X: <input type="text" id="lightPositionX4" value="0.7" /></td>
    <td>Y: <input type="text" id="lightPositionY4" value="0.5" /></td>
    <td>Z: <input type="text" id="lightPositionZ4" value="1.4" /></td>
    <th class="secondTH">Colour:</th>
    <td>R: <input type="text" id="pointR" value="0.5" /></td>
    <td>G: <input type="text" id="pointG" value="0.5" /></td>
    <td>B: <input type="text" id="pointB" value="0.5" /></td>
    </tr>
    <tr>
    <th class="secondTH">Spotlight Direction1:</th>
    <td>X: <input type="text" id="directionX1" value="0" /></td>
    <td>Y: <input type="text" id="directionY1" value="0.4" /></td>
    <td>Z: <input type="text" id="directionZ1" value="0" /></td>
    <th class="secondTH">Spotlight Direction2:</th>
    <td>X: <input type="text" id="directionX2" value="1" /></td>
    <td>Y: <input type="text" id="directionY2" value=".5" /></td>
    <td>Z: <input type="text" id="directionZ2" value="1" /></td>
    <th class="secondTH">Spotlight Direction3:</th>
    <td>X: <input type="text" id="directionX3" value="0" /></td>
    <td>Y: <input type="text" id="directionY3" value="0.3" /></td>
    <td>Z: <input type="text" id="directionZ3" value="-1" /></td>
    <th class="secondTH">Spotlight Direction4:</th>
    <td>X: <input type="text" id="directionX4" value="0" /></td>
    <td>Y: <input type="text" id="directionY4" value="0" /></td>
    <td>Z: <input type="text" id="directionZ4" value="1" /></td>
    <th>Ambient Colour:</th>
    <td>R: <input type="text" id="ambientR" value="0.5" /></td>
    <td>G: <input type="text" id="ambientG" value="0.5" /></td>
    <td>B: <input type="text" id="ambientB" value="0.5" /></td>
    </tr>
    <tr>
    <th>Spotlight Params:</th>
    <td colspan="7">Inner Angle: <input type="text" id="inner_angle" value="0.1" />
    &nbsp;Outer Angle: <input type="text" id="outer_angle" value="0.9" /></td>
    </tr>
    <tr>
    <th>Category:</th>
    <td colspan="7">
    <form id="categoryChanger">
    <input type="text" id="categoryInput" size="30" value="Category:Leonardo_da_Vinci_paintings" disabled="disabled" />
    <input type="submit" value="Go" disabled="disabled" />
    </form>
    </td>
    </tr>
    </table>
</div>
</body>

</html>
